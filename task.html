<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Tasks - Art Free Income</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; color: #2d3436; }
        .container { max-width: 600px; margin: 0 auto; padding-bottom: 30px; }
        
        .header-card { background: rgba(255, 255, 255, 0.95); padding: 25px; border-radius: 20px; text-align: center; margin-bottom: 25px; }
        .task-card { background: white; border-radius: 16px; padding: 20px; margin-bottom: 15px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        
        .task-icon { width: 50px; height: 50px; background: #e3f2fd; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; color: #2196f3; margin-right: 15px; }
        .task-info { flex-grow: 1; }
        .task-title { font-weight: 600; }
        .task-reward { color: #f1c40f; font-weight: 700; font-size: 0.85rem; }

        .action-btn { padding: 8px 15px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; min-width: 90px; }
        .btn-start { background: linear-gradient(to right, #6c5ce7, #a29bfe); color: white; }
        .btn-timer { background: #f1f2f6; color: #e17055; cursor: default; }
        .btn-done { background: #00b894; color: white; cursor: default; }

        .home-link { display: block; text-align: center; margin-top: 25px; color: white; text-decoration: none; background: rgba(255,255,255,0.2); padding: 10px; border-radius: 10px; }
    </style>
</head>
<body>

    <div class="container">
        <div class="header-card">
            <h2>Daily Tasks</h2>
            <p>Complete tasks to unlock VIP Salary!</p>
        </div>

        <div id="task-list">
            <div style="text-align: center; color: white;">Loading...</div>
        </div>

        <a href="home.html" class="home-link"><i class="fas fa-arrow-left"></i> Back to Dashboard</a>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-database.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyA-6c8nN8TUj9V8km-NAVkjgoIeQ5m7_ms",
            authDomain: "art-732d1.firebaseapp.com",
            databaseURL: "https://art-732d1-default-rtdb.firebaseio.com",
            projectId: "art-732d1",
            storageBucket: "art-732d1.appspot.com",
            messagingSenderId: "901862985233",
            appId: "1:901862985233:web:ddfd6b7c8a57c65ef0ebb0"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();
        let currentUserId = null;

        // টাস্কের সময় (টেস্টিংয়ের জন্য ১০ সেকেন্ড দেওয়া হলো, আপনি ২৪ ঘণ্টা চাইলে 24 * 60 * 60 * 1000 দিন)
        const TASK_DURATION_MS = 15000; // 15 Seconds for testing

        auth.onAuthStateChanged(user => {
            if (user) {
                currentUserId = user.uid;
                loadTasks();
            } else {
                window.location.href = 'login_register.html';
            }
        });

        async function loadTasks() {
            const taskListDiv = document.getElementById('task-list');
            const todayStr = new Date().toISOString().split('T')[0];

            try {
                const [tasksSnap, userSnap] = await Promise.all([
                    database.ref('tasks').once('value'),
                    database.ref(`users/${currentUserId}`).once('value')
                ]);

                const allTasks = tasksSnap.val() || {};
                const userData = userSnap.val() || {};
                const taskProgress = userData.taskProgress || {};
                const completedLog = (userData.completedTaskLog && userData.completedTaskLog[todayStr]) ? userData.completedTaskLog[todayStr] : {};

                // Check pending tasks
                let tasksToComplete = [];
                for (const taskId in taskProgress) {
                    if (Date.now() >= taskProgress[taskId].completionTime) {
                        tasksToComplete.push(taskId);
                    }
                }
                
                if (tasksToComplete.length > 0) {
                    await completeTasks(tasksToComplete, allTasks);
                    loadTasks(); // Reload after update
                    return;
                }

                renderTasks(allTasks, taskProgress, completedLog);

            } catch (error) {
                console.error(error);
                taskListDiv.innerHTML = '<p style="color:white; text-align:center;">Error loading tasks</p>';
            }
        }

        function renderTasks(allTasks, taskProgress, completedLog) {
            const listDiv = document.getElementById('task-list');
            listDiv.innerHTML = '';

            if (Object.keys(allTasks).length === 0) {
                listDiv.innerHTML = '<p style="color:white; text-align:center;">No tasks available.</p>';
                return;
            }

            for (const [taskId, task] of Object.entries(allTasks)) {
                const isCompletedToday = completedLog[taskId] === true;
                const inProgress = taskProgress[taskId];
                
                let btnHtml = '';

                if (isCompletedToday) {
                    btnHtml = `<button class="action-btn btn-done"><i class="fas fa-check"></i> Done</button>`;
                } else if (inProgress) {
                    btnHtml = `<button class="action-btn btn-timer" data-end="${inProgress.completionTime}">...</button>`;
                } else {
                    btnHtml = `<button class="action-btn btn-start" onclick="startTask('${taskId}', '${task.link}')">Start</button>`;
                }

                listDiv.innerHTML += `
                    <div class="task-card">
                        <div style="display:flex; align-items:center;">
                            <div class="task-icon"><i class="fab fa-chrome"></i></div>
                            <div class="task-info">
                                <div class="task-title">${task.name}</div>
                                <div class="task-reward">+${task.reward} TC</div>
                            </div>
                        </div>
                        ${btnHtml}
                    </div>
                `;
            }
            startTimerLoop();
        }

        function startTask(taskId, link) {
            if(link) window.open(link, '_blank');

            const completionTime = Date.now() + TASK_DURATION_MS;
            database.ref(`users/${currentUserId}/taskProgress/${taskId}`).set({
                status: 'running',
                completionTime: completionTime
            }).then(() => loadTasks());
        }

        async function completeTasks(taskIds, allTasks) {
            const todayStr = new Date().toISOString().split('T')[0];
            let totalReward = 0;

            taskIds.forEach(id => {
                if(allTasks[id]) totalReward += parseFloat(allTasks[id].reward);
            });

            const userRef = database.ref(`users/${currentUserId}`);
            await userRef.transaction(user => {
                if (user) {
                    user.balance = (user.balance || 0) + totalReward;
                    if (!user.completedTaskLog) user.completedTaskLog = {};
                    if (!user.completedTaskLog[todayStr]) user.completedTaskLog[todayStr] = {};

                    taskIds.forEach(id => {
                        user.completedTaskLog[todayStr][id] = true; // Mark as done for today
                        if(user.taskProgress) delete user.taskProgress[id]; // Remove from running
                    });
                }
                return user;
            });
            alert(`Tasks Completed! +${totalReward} TC Added.`);
        }

        function startTimerLoop() {
            if(window.timerInterval) clearInterval(window.timerInterval);
            window.timerInterval = setInterval(() => {
                document.querySelectorAll('.btn-timer').forEach(btn => {
                    const endTime = parseInt(btn.getAttribute('data-end'));
                    const left = endTime - Date.now();
                    
                    if (left <= 0) {
                        btn.innerText = "Checking...";
                        if (left < -2000) loadTasks(); // Force reload
                    } else {
                        const s = Math.ceil(left / 1000);
                        btn.innerText = `${s}s`;
                    }
                });
            }, 1000);
        }
    </script>
</body>
</html>
