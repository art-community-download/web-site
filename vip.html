<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VIP Lounge</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; color: #2d3436; }
        .container { max-width: 600px; margin: 0 auto; padding-bottom: 50px; }
        
        .header-card { background: rgba(255, 255, 255, 0.95); padding: 25px; border-radius: 20px; text-align: center; margin-bottom: 25px; }
        .referral-badge { background: #e3f2fd; color: #0984e3; padding: 5px 15px; border-radius: 20px; font-weight: 600; display: inline-block; margin: 10px 0; }
        
        .level-card { background: white; border-radius: 16px; padding: 20px; margin-bottom: 15px; border: 2px solid transparent; opacity: 0.8; filter: grayscale(1); }
        .level-card.active { border-color: #6c5ce7; opacity: 1; filter: none; transform: scale(1.02); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        
        .level-header { display: flex; justify-content: space-between; font-weight: 700; margin-bottom: 10px; }
        .income { color: #00b894; }
        
        .progress-bar { background: #dfe6e9; height: 8px; border-radius: 4px; margin: 10px 0; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #6c5ce7, #a29bfe); width: 0%; transition: width 0.5s; }
        
        .btn { width: 100%; padding: 12px; border: none; border-radius: 10px; font-weight: 700; margin-top: 10px; cursor: pointer; }
        .btn-lock { background: #b2bec3; color: white; cursor: not-allowed; }
        .btn-claim { background: linear-gradient(to right, #6c5ce7, #a29bfe); color: white; box-shadow: 0 4px 10px rgba(108, 92, 231, 0.3); }
        .btn-done { background: #00b894; color: white; cursor: default; }
        .btn-alert { background: #ff7675; color: white; animation: pulse 1.5s infinite; }

        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(0.98); } 100% { transform: scale(1); } }
        .home-link { display: block; text-align: center; margin-top: 20px; color: white; text-decoration: none; }
    </style>
</head>
<body>

    <div class="container">
        <div class="header-card">
            <h2>VIP Lounge</h2>
            <div class="referral-badge">My Referrals: <span id="ref-count">0</span></div>
            <p>Current Rank: <strong id="rank-name" style="color: #6c5ce7;">None</strong></p>
        </div>

        <div id="levels-container">
            <p style="text-align:center; color:white;">Checking Eligibility...</p>
        </div>

        <a href="home.html" class="home-link">Back to Dashboard</a>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-database.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyA-6c8nN8TUj9V8km-NAVkjgoIeQ5m7_ms",
            authDomain: "art-732d1.firebaseapp.com",
            databaseURL: "https://art-732d1-default-rtdb.firebaseio.com",
            projectId: "art-732d1",
            storageBucket: "art-732d1.appspot.com",
            messagingSenderId: "901862985233",
            appId: "1:901862985233:web:ddfd6b7c8a57c65ef0ebb0"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();
        let currentUser = null;

        const vipLevels = [
            { id: 1, name: "Level 1", req: 25, bonus: 100 },
            { id: 2, name: "Level 2", req: 50, bonus: 200 },
            { id: 3, name: "Level 3", req: 75, bonus: 300 },
            { id: 4, name: "Level 4", req: 100, bonus: 500 },
            { id: 5, name: "Level 5", req: 125, bonus: 600 },
            { id: 6, name: "Level 6", req: 150, bonus: 800 },
            { id: 7, name: "Level 7", req: 200, bonus: 1200 }
        ];

        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                loadVipData();
            } else {
                window.location.href = 'login_register.html';
            }
        });

        function loadVipData() {
            const userRef = database.ref('users/' + currentUser.uid);
            const taskRef = database.ref('tasks');

            Promise.all([userRef.once('value'), taskRef.once('value')]).then(([userSnap, taskSnap]) => {
                const userData = userSnap.val() || {};
                const allTasks = taskSnap.val() || {};
                
                // Realtime update listener
                userRef.on('value', snap => updateUI(snap.val(), allTasks));
            });
        }

        function updateUI(userData, allTasks) {
            const referrals = userData.referralCount || 0;
            const lastClaim = userData.lastVipClaimDate || "";
            const todayStr = new Date().toISOString().split('T')[0];
            
            // --- MAIN LOGIC CONNECTION ---
            const totalTasks = Object.keys(allTasks).length;
            const completedToday = (userData.completedTaskLog && userData.completedTaskLog[todayStr]) ? Object.keys(userData.completedTaskLog[todayStr]).length : 0;
            const isTaskDone = completedToday >= totalTasks && totalTasks > 0;
            // -----------------------------

            document.getElementById('ref-count').innerText = referrals;
            const container = document.getElementById('levels-container');
            container.innerHTML = "";

            let highestLevelId = 0;
            vipLevels.forEach(l => { if(referrals >= l.req) highestLevelId = l.id; });
            document.getElementById('rank-name').innerText = highestLevelId > 0 ? `Level ${highestLevelId}` : "None";

            vipLevels.forEach(level => {
                const isUnlocked = referrals >= level.req;
                const isCurrentMax = level.id === highestLevelId;
                const percent = Math.min((referrals/level.req)*100, 100);

                let btnHtml = '';
                if (!isUnlocked) {
                    btnHtml = `<button class="btn btn-lock"><i class="fas fa-lock"></i> Locked</button>`;
                } else if (isCurrentMax) {
                    if (lastClaim === todayStr) {
                        btnHtml = `<button class="btn btn-done">Claimed Today</button>`;
                    } else if (!isTaskDone) {
                        // কানেকশন: টাস্ক শেষ না হলে এই বাটন দেখাবে
                        btnHtml = `<button class="btn btn-alert" onclick="location.href='task.html'">
                                    <i class="fas fa-exclamation-triangle"></i> Complete Tasks First
                                   </button>`;
                    } else {
                        btnHtml = `<button class="btn btn-claim" onclick="claimVip(${level.id}, ${level.bonus})">
                                    Claim ${level.bonus} TC
                                   </button>`;
                    }
                } else {
                    btnHtml = `<button class="btn btn-lock">Passed Level</button>`;
                }

                container.innerHTML += `
                    <div class="level-card ${isCurrentMax ? 'active' : ''}">
                        <div class="level-header">
                            <span>${level.name}</span>
                            <span class="income">+${level.bonus} TC</span>
                        </div>
                        <div class="progress-bar"><div class="progress-fill" style="width:${percent}%"></div></div>
                        <div style="font-size:0.8rem; color:#636e72; display:flex; justify-content:space-between;">
                            <span>${referrals}/${level.req} Refs</span>
                            <span>Tasks: ${isTaskDone ? '<b style="color:green">Done</b>' : '<b style="color:red">Pending</b>'}</span>
                        </div>
                        ${btnHtml}
                    </div>
                `;
            });
        }

        function claimVip(levelId, amount) {
            const today = new Date().toISOString().split('T')[0];
            const userRef = database.ref('users/' + currentUser.uid);
            const taskRef = database.ref('tasks');

            // Security Check inside Transaction
            taskRef.once('value', taskSnap => {
                const totalTasks = taskSnap.numChildren();
                
                userRef.transaction(user => {
                    if (user) {
                        if (user.lastVipClaimDate === today) return; // Already claimed

                        // Verify tasks again inside transaction
                        const doneCount = (user.completedTaskLog && user.completedTaskLog[today]) ? Object.keys(user.completedTaskLog[today]).length : 0;
                        
                        if (doneCount < totalTasks) return; // Cheating attempt block

                        user.balance = (user.balance || 0) + amount;
                        user.lastVipClaimDate = today;
                    }
                    return user;
                }, (err, committed, snap) => {
                    if(!committed) {
                        const val = snap.val();
                        if(val.lastVipClaimDate === today) alert("Already claimed today!");
                        else alert("Please complete all daily tasks first!");
                    } else {
                        alert("Success! VIP Bonus Added.");
                    }
                });
            });
        }
    </script>
</body>
</html>
