<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Withdraw - Art Free Income</title>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
        }

        .container {
            width: 100%;
            max-width: 500px;
        }

        /* Notice Box */
        .notice-card {
            background: rgba(255, 255, 255, 0.9);
            border-left: 5px solid #ff7675;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .notice-card p {
            font-size: 0.9rem;
            color: #d63031;
            font-weight: 500;
            line-height: 1.5;
        }

        .notice-icon {
            font-size: 1.2rem;
            margin-right: 8px;
            vertical-align: middle;
        }

        /* Main Card */
        .withdraw-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        }

        .header-title {
            text-align: center;
            font-size: 1.5rem;
            color: #2d3436;
            margin-bottom: 20px;
            font-weight: 700;
        }

        /* Balance Display */
        .balance-box {
            background: linear-gradient(to right, #6c5ce7, #a29bfe);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            color: white;
            margin-bottom: 25px;
        }

        .balance-label {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-bottom: 5px;
            display: block;
        }

        .balance-amount {
            font-size: 2rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        /* Requirements Box */
        .req-box {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid #dfe6e9;
        }

        .req-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: #2d3436;
            margin-bottom: 10px;
            text-align: center;
            text-transform: uppercase;
        }

        .req-item {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            color: #636e72;
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid #eee;
        }

        .req-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .status-ok { color: #00b894; font-weight: bold; }
        .status-no { color: #d63031; font-weight: bold; }

        /* Form Styling */
        .form-group {
            margin-bottom: 1.2rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #2d3436;
            font-size: 0.9rem;
        }

        .input-wrapper {
            position: relative;
        }

        .input-wrapper i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #b2bec3;
        }

        select, input {
            width: 100%;
            padding: 12px 15px 12px 40px;
            border: 2px solid #e1e1e1;
            border-radius: 10px;
            font-size: 0.95rem;
            background: white;
            transition: all 0.3s;
            appearance: none; /* Remove default arrow */
        }

        select:focus, input:focus {
            border-color: #6c5ce7;
            outline: none;
        }

        /* Withdraw Button */
        .withdraw-btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 12px;
            background: #2d3436; /* Default disabled look */
            color: white;
            font-size: 1rem;
            font-weight: 700;
            cursor: not-allowed;
            transition: background 0.3s, transform 0.2s;
            margin-top: 10px;
            opacity: 0.7;
        }

        .withdraw-btn.active {
            background: linear-gradient(to right, #6c5ce7, #a29bfe);
            cursor: pointer;
            opacity: 1;
            box-shadow: 0 4px 15px rgba(108, 92, 231, 0.4);
        }

        .withdraw-btn.active:hover {
            transform: translateY(-2px);
        }

        .home-link {
            display: block;
            text-align: center;
            margin-top: 20px;
            color: white;
            text-decoration: none;
            font-weight: 500;
            opacity: 0.9;
        }

        /* Custom Select Arrow */
        .select-arrow {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #b2bec3;
            pointer-events: none;
        }

    </style>
</head>
<body>

    <div class="container">
        
        <!-- Important Notice -->
        <div class="notice-card">
            <p>
                <i class="fas fa-exclamation-triangle notice-icon"></i>
                <strong>Notice:</strong>ðŸ“¢ Important Announcement â€” For All Taka Coin (TC) Holders

Our project is progressing rapidly.
Once Taka Coin gets officially listed, you will be able to exchange your coins and withdraw money directly to your bKash or Nagad account.

ðŸ‘‰ Within the next 6 months, we are planning to:
â€¢ Apply for TC Coin Listing on Binance
â€¢ Officially Release on Bybit

Our support team will keep you updated regularly.
Thank you for staying with us â€” stay safe and stay connected.
            </p>
        </div>

        <div class="withdraw-card">
            <h2 class="header-title">Withdraw Coins</h2>

            <!-- Balance Display -->
            <div class="balance-box">
                <span class="balance-label">Available Balance</span>
                <div class="balance-amount">
                    <i class="fas fa-coins" style="color: #f1c40f;"></i>
                    <span id="current-balance">0.00</span> TC
                </div>
            </div>

            <!-- Requirements Display -->
            <div class="req-box">
                <div class="req-title">Eligibility Requirements</div>
                <div class="req-item">
                    <span>Minimum Coins:</span>
                    <strong id="min-balance-req">Loading...</strong>
                </div>
                <div class="req-item">
                    <span>Referrals Needed:</span>
                    <strong><span id="user-referrals-current">0</span> / <span id="min-referrals-req">0</span></strong>
                </div>
            </div>

            <!-- Payment Method -->
            <div class="form-group">
                <label>Select Wallet</label>
                <div class="input-wrapper">
                    <i class="fas fa-wallet"></i>
                    <select id="payment-method">
                        <option value="bKash">bKash</option>
                        <option value="Nagad">Nagad</option>
                    </select>
                    <i class="fas fa-chevron-down select-arrow"></i>
                </div>
            </div>

            <!-- Account Number -->
            <div class="form-group">
                <label>Personal Number</label>
                <div class="input-wrapper">
                    <i class="fas fa-phone-alt"></i>
                    <input type="number" id="account-number" placeholder="e.g. 017xxxxxxxx">
                </div>
            </div>

            <!-- Amount Input -->
            <div class="form-group">
                <label>Withdraw Amount (Coins)</label>
                <div class="input-wrapper">
                    <i class="fas fa-coins"></i>
                    <input type="number" id="amount" placeholder="Enter coin amount">
                </div>
            </div>

            <button id="withdraw-btn" class="withdraw-btn" onclick="requestWithdrawal()" disabled>Loading Data...</button>
        </div>

        <a href="home.html" class="home-link">Back to Dashboard</a>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-database.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyA-6c8nN8TUj9V8km-NAVkjgoIeQ5m7_ms",
            authDomain: "art-732d1.firebaseapp.com",
            databaseURL: "https://art-732d1-default-rtdb.firebaseio.com",
            projectId: "art-732d1",
            storageBucket: "art-732d1.appspot.com",
            messagingSenderId: "901862985233",
            appId: "1:901862985233:web:ddfd6b7c8a57c65ef0ebb0"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();
        
        let currentUser = null;
        let userBalance = 0;
        let userReferralCount = 0;
        let withdrawalSettings = { minBalance: 1000, minReferrals: 0 }; // Default Fallback

        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                loadPageData(user.uid);
            } else {
                window.location.href = 'login_register.html';
            }
        });

        async function loadPageData(userId) {
            const settingsRef = database.ref('settings/withdrawal');
            const userRef = database.ref('users/' + userId);

            try {
                // Fetch Settings & User Data concurrently
                const [settingsSnapshot, userSnapshot] = await Promise.all([
                    settingsRef.once('value'),
                    userRef.once('value')
                ]);

                // Settings from Admin
                if (settingsSnapshot.exists()) {
                    const settings = settingsSnapshot.val();
                    withdrawalSettings.minBalance = settings.minBalance || 1000;
                    withdrawalSettings.minReferrals = settings.minReferrals || 0;
                }

                // User Info
                const userData = userSnapshot.val() || { balance: 0, referralCount: 0 };
                userBalance = userData.balance || 0;
                userReferralCount = userData.referralCount || 0;

                // Update UI Text
                document.getElementById('current-balance').innerText = userBalance.toFixed(2);
                document.getElementById('min-balance-req').innerText = `${withdrawalSettings.minBalance} TC`;
                document.getElementById('user-referrals-current').innerText = userReferralCount;
                document.getElementById('min-referrals-req').innerText = withdrawalSettings.minReferrals;

                // Colorize Status
                const refElem = document.getElementById('user-referrals-current');
                if(userReferralCount >= withdrawalSettings.minReferrals) {
                    refElem.classList.add('status-ok');
                    refElem.classList.remove('status-no');
                } else {
                    refElem.classList.add('status-no');
                    refElem.classList.remove('status-ok');
                }

                checkWithdrawalEligibility();

            } catch (error) {
                console.error("Data Load Error:", error);
                document.getElementById('withdraw-btn').innerText = "System Error";
            }
        }

        function checkWithdrawalEligibility() {
            const withdrawBtn = document.getElementById('withdraw-btn');
            
            // Check both Balance & Referral Criteria
            const isEligible = userBalance >= withdrawalSettings.minBalance && userReferralCount >= withdrawalSettings.minReferrals;

            if (isEligible) {
                withdrawBtn.disabled = false;
                withdrawBtn.classList.add('active');
                withdrawBtn.innerText = 'Request Withdrawal';
            } else {
                withdrawBtn.disabled = true;
                withdrawBtn.classList.remove('active');
                
                if (userBalance < withdrawalSettings.minBalance) {
                    withdrawBtn.innerText = `Need ${withdrawalSettings.minBalance} Coins`;
                } else {
                    withdrawBtn.innerText = `Need ${withdrawalSettings.minReferrals} Referrals`;
                }
            }
        }

        function requestWithdrawal() {
            // Security Check
            if (userBalance < withdrawalSettings.minBalance || userReferralCount < withdrawalSettings.minReferrals) {
                alert("You do not meet the withdrawal requirements.");
                return;
            }

            const method = document.getElementById('payment-method').value;
            const number = document.getElementById('account-number').value;
            const amount = parseFloat(document.getElementById('amount').value);

            if (isNaN(amount) || amount <= 0) {
                alert("Please enter a valid coin amount.");
                return;
            }
            if (amount < withdrawalSettings.minBalance) {
                alert(`Minimum withdrawal amount is ${withdrawalSettings.minBalance} TC.`);
                return;
            }
            if (amount > userBalance) {
                alert("Insufficient coin balance.");
                return;
            }
            if (number.length < 11) {
                alert("Please enter a valid 11-digit mobile number.");
                return;
            }

            // Deduct Coins & Create Record
            const newBalance = userBalance - amount;
            const withdrawalId = database.ref().child('withdrawals').push().key;

            const withdrawalData = {
                userId: currentUser.uid,
                method: method,
                accountNumber: number,
                amount: amount,
                status: 'pending', // Pending Admin Approval
                requestedAt: new Date().toISOString()
            };

            const updates = {};
            updates['/withdrawals/' + withdrawalId] = withdrawalData;
            updates['/users/' + currentUser.uid + '/balance'] = newBalance;

            database.ref().update(updates)
                .then(() => {
                    alert('Withdrawal request submitted! Please wait for listing/approval.');
                    document.getElementById('amount').value = '';
                    document.getElementById('account-number').value = '';
                    loadPageData(currentUser.uid); // Refresh Data
                })
                .catch((error) => {
                    alert('Error submitting request: ' + error.message);
                });
        }
    </script>

</body>
</html>
